<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Jugar Tutifrutti - Completa las categor√≠as con palabras que empiecen con la letra seleccionada">
  <title>Juego - Tutifrutti</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/base.css">
  <link rel="stylesheet" href="/public/css/components.css">
  <link rel="stylesheet" href="/public/css/game.css">
  
  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="game-layout">
  <!-- Header del juego -->
  <header class="game-header">
    <div class="container">
      <div class="game-header__content">
        <h1 class="game-title">
          <span class="game-title__emoji" aria-hidden="true">üçé</span>
          Tutti Frutti
        </h1>
        <div class="game-info">
          <div class="player-name" id="playerName" aria-live="polite">
            Jugador: Cargando...
          </div>
          <div class="players-count" id="playersCount" aria-live="polite">
            Jugadores: 0/5
          </div>
          <div class="timer-display" id="timerDisplay" role="timer" aria-live="assertive">
            Esperando...
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenido principal -->
  <main id="main-content" class="game-main">
    <!-- Panel de estado del juego -->
    <section class="game-status">
      <div class="status-message" id="selectedLetter" aria-live="polite">
        Esperando que comience el juego...
      </div>
      <div id="roulette" style="display: none;" role="img" aria-label="Ruleta de letras"></div>

    </section>

    <!-- √Årea de juego -->
    <section class="game-area">
      <!-- Showcase de letra seleccionada -->
      <div class="letter-showcase">
        <div class="letter-label">LETRA SELECCIONADA</div>
        <div class="letter-big" id="currentLetterDisplay" 
             role="img" 
             aria-label="Letra actual">?</div>
      </div>

      <!-- Rejilla din√°mica de categor√≠as -->
      <div class="categories-grid" id="categoriesGrid" role="group" aria-label="Categor√≠as del juego">
        <!-- Se renderiza din√°micamente con uiManager.renderCategoriesGrid -->
      </div>
    </section>

    <!-- Panel de puntuaci√≥n -->
    <section class="score-panel">
      <h2 class="score-title">
        <span aria-hidden="true">üìä</span>
        Puntuaci√≥n
      </h2>
      <div class="score-grid" role="group" aria-label="Puntuaciones actuales">
        <div class="score-item">
          <span class="score-label">Repetidas</span>
          <span class="score-value" id="score-repetidas" aria-label="Puntos por palabras repetidas">0</span>
        </div>
        <div class="score-item">
          <span class="score-label">√önicas x2</span>
          <span class="score-value" id="score-unicas" aria-label="Puntos por palabras √∫nicas">0</span>
        </div>
        <div class="score-item">
          <span class="score-label">+3 S√≠labas x3</span>
          <span class="score-value" id="score-silabas" aria-label="Puntos por palabras con m√°s de 3 s√≠labas">0</span>
        </div>
        <div class="score-item total">
          <span class="score-label">Total</span>
          <span class="score-value" id="score-total" aria-label="Puntuaci√≥n total">0</span>
        </div>
      </div>
    </section>

    <!-- Controles del juego -->
    <section class="game-controls">
      <button id="startGameButton" 
              class="btn btn--primary btn--lg" 
              style="display: none;"
              aria-describedby="start-game-help">
        <span aria-hidden="true">üéÆ</span>
        Iniciar Juego
      </button>
      <div id="start-game-help" class="sr-only">
        Solo el anfitri√≥n puede iniciar el juego
      </div>
      
      <button id="spinWheelButton" 
              class="btn btn--secondary btn--lg" 
              style="display: none;"
              aria-describedby="spin-wheel-help">

        <span aria-hidden="true">üé∞</span>
        Girar Ruleta
      </button>
      <div id="spin-wheel-help" class="sr-only">
        Gira la ruleta para seleccionar una letra
      </div>
      
      <button id="submitWordButton" 
              class="btn btn--success btn--lg" 
              disabled
              aria-describedby="submit-words-help">
        <span aria-hidden="true">‚úÖ</span>
        Enviar Palabras
      </button>
      <div id="submit-words-help" class="sr-only">
        Env√≠a tus palabras cuando hayas terminado o se acabe el tiempo
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script type="module">
    import { socketManager } from '/public/js/socket-manager.js';
    import { gameState } from '/public/js/game-state.js';
    import { uiManager } from '/public/js/ui-manager.js';
    import { storage, validateWord, showNotification } from '/utils/helpers.js';
    import { SOCKET_EVENTS, ROUTES, GAME_CONFIG } from '/utils/constants.js';

    // Referencias a elementos
    const startGameButton = document.getElementById('startGameButton');
    const spinWheelButton = document.getElementById('spinWheelButton');
    const submitWordButton = document.getElementById('submitWordButton');
    const playerNameElement = document.getElementById('playerName');

    // Exponer para acceso global
    window.gameModule = {
      submitWords: submitWordsClassic
    };

    // Inicializaci√≥n
    init();

    function init() {
      // Verificar usuario y sala
      const username = storage.getUsername();
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get('roomId') || storage.getCurrentRoomId();

      if (!username) {
        showNotification('Debes ingresar tu nombre primero', 'error');
        window.location.href = ROUTES.HOME;
        return;
      }

      if (!roomId) {
        showNotification('No se especific√≥ una sala v√°lida', 'error');
        window.location.href = ROUTES.CREATE_ROOM;
        return;
      }

      // Configurar estado del juego
      gameState.username = username;
      gameState.roomId = roomId;

      // Mostrar nombre del jugador
      if (playerNameElement) {
        playerNameElement.textContent = `Jugador: ${username}`;
      }

      // Inicializar componentes
      uiManager.init();
      
      // Conectar socket y configurar eventos
      socketManager.connect();
      window.socketManager = socketManager;
      setupSocketListeners();
      setupEventListeners();
      attachWordInputEvents();

      // NO unirse nuevamente - ya estamos unidos desde la sala de espera
      // En su lugar, solicitar el estado actual de la sala
      requestRoomState(roomId);

      console.log('Juego inicializado:', { username, roomId });
    }

    function requestRoomState(roomId) {
      // Verificar si venimos de la sala de espera (evitar doble uni√≥n)
      const cameFromWaitingRoom = document.referrer.includes('join-room.html') || 
                                  document.referrer.includes('create-room.html');
      
      // Siempre intentar rehidratar estado v√≠a getRoomState y reconectar internamente
      socketManager.getRoomState({ roomId });
      console.log('Solicitando estado de sala');
    }

    function setupEventListeners() {
      // Bot√≥n iniciar juego
      startGameButton?.addEventListener('click', () => {
        if (gameState.isHost) {
          socketManager.startGame(gameState.roomId);
        } else {
          showNotification('Solo el anfitri√≥n puede iniciar el juego', 'warning');
        }
      });

      // Bot√≥n girar ruleta
      spinWheelButton?.addEventListener('click', () => {
        if (gameState.isHost && gameState.gameStarted) {
          socketManager.spinRoulette(gameState.roomId);
        } else if (!gameState.gameStarted) {
          showNotification('El juego a√∫n no ha comenzado', 'warning');
        } else {
          showNotification('Solo el anfitri√≥n puede girar la ruleta', 'warning');
        }
      });

      // Bot√≥n enviar palabras
      submitWordButton?.addEventListener('click', submitWordsClassic);
    }

    function attachWordInputEvents() {
      const wordInputs = document.querySelectorAll('.word-input');
      
      wordInputs.forEach((input, index) => {
        // Navegaci√≥n con Enter
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            moveToNextCategory(index);
          }
          
          // Enviar con Ctrl+Enter
          if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            submitWordsClassic();
          }
        });

        // Validaci√≥n en tiempo real
        input.addEventListener('input', function() {
          const category = this.getAttribute('data-category');
          const word = this.value.trim();
          const isValid = word ? validateWord(word, gameState.currentLetter) : false;
          
          // Actualizar visualizaci√≥n
          uiManager.updateWordDisplay(category, word, isValid);

          // Marcar tarjeta completada si tiene contenido
          const card = this.closest('.category-card');
          if (card) {
            if (word.length > 0) {
              card.classList.add('completed');
            } else {
              card.classList.remove('completed');
            }
          }
          
          // Verificar si todas las palabras est√°n completas
          checkAllWordsCompleted();
        });

        // Gesti√≥n del foco
        input.addEventListener('focus', function() {
          uiManager.setActiveInput(this);
        });

        input.addEventListener('blur', function() {
          uiManager.removeActiveInput(this);
        });
      });
    }

    function setupSocketListeners() {
      // Conexi√≥n y errores
      socketManager.on(SOCKET_EVENTS.JOINED_ROOM, handleJoinedRoom);
      socketManager.on(SOCKET_EVENTS.PLAYER_JOINED, handlePlayerJoined);
      socketManager.on(SOCKET_EVENTS.PLAYER_LEFT, handlePlayerLeft);
      
      // Estado de la sala
      socketManager.on(SOCKET_EVENTS.ROOM_STATE, handleRoomState);
      
      // Juego
      socketManager.on(SOCKET_EVENTS.SHOW_ROULETTE, handleShowRoulette);
      socketManager.on(SOCKET_EVENTS.ROULETTE_SPINNING, handleRouletteSpinning);
      socketManager.on(SOCKET_EVENTS.ROULETTE_RESULT, handleRouletteResult);
      socketManager.on(SOCKET_EVENTS.TIMER_UPDATE, handleTimerUpdate);
      socketManager.on(SOCKET_EVENTS.ROUND_ENDED, handleRoundEnded);
      socketManager.on(SOCKET_EVENTS.GAME_ENDED, handleGameEnded);

      // Nuevos eventos (flujo sin ruleta)
      socketManager.on(SOCKET_EVENTS.ROUND_START, handleRoundStart);
      socketManager.on(SOCKET_EVENTS.START_REVIEW, handleStartReview);
      socketManager.on(SOCKET_EVENTS.VOTE_UPDATE, handleVoteUpdate);
      socketManager.on(SOCKET_EVENTS.REVIEW_ENDED, handleReviewEnded);

      // Alineaci√≥n con eventos adicionales
      socketManager.on(SOCKET_EVENTS.YOU_ARE_CREATOR, () => {
        gameState.setHost(true);
        const startButton = document.getElementById('startGameButton');
        if (startButton) startButton.style.display = 'block';
      });
      socketManager.on(SOCKET_EVENTS.NEW_ROUND, (data) => {
        // Preparar UI para nueva ronda, letra y temporizador provendr√°n del servidor
        gameState.currentRound = data.round;
        document.getElementById('selectedLetter').textContent = 'Nueva ronda. Esperando ruleta...';
        uiManager.showRoulette();
      });
    }

    function handleRoomState(data) {
      console.log('Estado de la sala recibido:', data);
      
      if (!data || !data.players) {
        console.error('Estado de sala inv√°lido:', data);
        showNotification('Error al cargar el estado de la sala', 'error');
        return;
      }
      
      // Actualizar estado del juego
      gameState.updatePlayers(data.players);
      
      // Verificar si el jugador actual es el creador
      const currentPlayer = data.players.find(p => p.name === gameState.username);
      const isCreator = currentPlayer ? currentPlayer.isCreator : false;
      gameState.setHost(isCreator);
      
      console.log(`Jugador actual: ${gameState.username}, Es creador: ${isCreator}`);
      
      // Si el juego est√° en curso pero a√∫n no hay letra (venimos redirigidos tras SHOW_ROULETTE),
      // debemos mostrar la ruleta y el bot√≥n de girar (habilitado solo para host)
      if (data.isPlaying) {
        gameState.startGame();
        if (data.currentLetter) {
          // Juego en curso con letra definida: renderizar categor√≠as y habilitar inputs
          uiManager.renderCategoriesGrid(data.categories || GAME_CONFIG.CATEGORIES);
          attachWordInputEvents();
          gameState.setCurrentLetter(data.currentLetter);
        } else {
          // Juego en curso sin letra a√∫n: mostrar ruleta y bot√≥n de girar
          gameState.disableInputs();
          uiManager.showRoulette();
          if (spinWheelButton) {
            spinWheelButton.style.display = 'block';
            spinWheelButton.disabled = !isCreator;
            spinWheelButton.innerHTML = isCreator
              ? '<span aria-hidden="true">üé∞</span> Girar Ruleta'
              : '<span aria-hidden="true">‚è≥</span> Esperando al anfitri√≥n';
          }
          document.getElementById('selectedLetter').textContent = isCreator
            ? '¬°Haz clic en "Girar Ruleta" para comenzar!'
            : 'Esperando que el anfitri√≥n gire la ruleta...';
        }
        if (startGameButton) startGameButton.style.display = 'none';
      } else if (isCreator) {
        // Mostrar bot√≥n de iniciar juego si es el creador y el juego no ha empezado
        if (startGameButton) {
          startGameButton.style.display = 'block';
        }
        uiManager.announce('Eres el anfitri√≥n. Puedes iniciar el juego cuando est√©s listo.');
      }
      
      uiManager.announce(`Estado del juego cargado. ${data.players.length} jugadores en la sala.`);
      showNotification('¬°Listo para jugar!', 'success');
    }

    function handleJoinedRoom(data) {
      console.log('Unido a la sala:', data);
      
      gameState.updatePlayers(data.players || []);
      const isCreator = data.isCreator || false;
      gameState.setHost(isCreator);
      
      console.log(`Unido a sala - Es creador: ${isCreator}`);
      
      // Si es el creador, mostrar controles apropiados
      if (isCreator) {
        const startButton = document.getElementById('startGameButton');
        if (startButton) {
          startButton.style.display = 'block';
        }
        uiManager.announce('Eres el anfitri√≥n de esta sala.');
      }
      
      uiManager.announce(`Te has unido a la sala. Hay ${data.players?.length || 0} jugadores.`);
    }

    function handlePlayerJoined(data) {
      console.log('Jugador se uni√≥:', data);
      if (data && data.players) {
        gameState.updatePlayers(data.players);
      }
      const playerName = data?.player?.name;
      if (playerName && playerName !== gameState.username) {
        uiManager.announce(`${playerName} se uni√≥ al juego`);
        showNotification(`${playerName} se uni√≥ al juego`, 'info');
      }
    }

    function handlePlayerLeft(data) {
      console.log('Jugador se fue:', data);
      
      if (data.players) {
        gameState.updatePlayers(data.players);
        
        if (data.playerName && data.playerName !== gameState.username) {
          uiManager.announce(`${data.playerName} dej√≥ el juego`);
          showNotification(`${data.playerName} dej√≥ el juego`, 'info');
        }
      }
    }

function handleShowRoulette(data) {
      console.log('Mostrando ruleta:', data);
      
      gameState.startGame();
      // Mientras se muestra la ruleta nadie deber√≠a escribir
      gameState.disableInputs();
      uiManager.showRoulette();
      
      // Mostrar SIEMPRE el bot√≥n de girar para evitar condiciones de carrera,
      // deshabilitado para no‚Äëhost. El servidor valida permisos igualmente.
      if (spinWheelButton) {
        spinWheelButton.style.display = 'block';
        const isHost = !!gameState.isHost;
        spinWheelButton.disabled = !isHost;
        spinWheelButton.innerHTML = isHost
          ? '<span aria-hidden="true">üé∞</span> Girar Ruleta'
          : '<span aria-hidden="true">‚è≥</span> Esperando al anfitri√≥n';
      }
      document.getElementById('selectedLetter').textContent = gameState.isHost
        ? '¬°Haz clic en "Girar Ruleta" para comenzar!'
        : 'Esperando que el anfitri√≥n gire la ruleta...';
      
      if (startGameButton) startGameButton.style.display = 'none';
      uiManager.announce('El juego ha comenzado. Esperando que se gire la ruleta.');
    }

    function handleRouletteSpinning() {
      console.log('La ruleta est√° girando...');
      
      // Deshabilitar bot√≥n de girar
      if (spinWheelButton) {
        spinWheelButton.disabled = true;
        spinWheelButton.innerHTML = '<span class="spinner"></span> Girando...';
      }
      
      // Mostrar animaci√≥n
      uiManager.animateRouletteSpinning();
      
      document.getElementById('selectedLetter').textContent = 'üé∞ La ruleta est√° girando...';
      uiManager.announce('La ruleta est√° girando...');
    }

    function handleRouletteResult(data) {
      console.log('[Game] handleRouletteResult ->', data);

      // Mantener la ruleta visible y girarla exactamente a la letra enviada
      if (typeof uiManager.spinToLetter === 'function') {
        uiManager.spinToLetter(data.letter);
      }

      // Ocultar bot√≥n de girar para todos
      if (spinWheelButton) {
        spinWheelButton.style.display = 'none';
      }

      // Tras la animaci√≥n, mostrar letra grande y habilitar inputs para todos
      setTimeout(() => {
        uiManager.hideRoulette();
        uiManager.displaySelectedLetter(data.letter);

        // Render din√°mico de categor√≠as y habilitar inputs (compatibilidad con flujo nuevo)
        uiManager.renderCategoriesGrid(GAME_CONFIG.CATEGORIES);
        attachWordInputEvents();
        gameState.setCurrentLetter(data.letter);
        gameState.enableInputs();
      }, 1200);
    }

    // Nuevo flujo sin ruleta
    function handleRoundStart(data) {
      try {
        const categories = data?.categories || GAME_CONFIG.CATEGORIES;
        // Ocultar cualquier ruleta legacy
        uiManager.hideRoulette();
        // Render de categor√≠as din√°micas
        uiManager.renderCategoriesGrid(categories);
        attachWordInputEvents();
        // Mostrar letra y habilitar inputs
        uiManager.displaySelectedLetter(data.letter);
        gameState.setCurrentLetter(data.letter);
        gameState.enableInputs();

        // Enfocar primer input disponible
        const first = document.querySelector('.word-input:not([disabled])');
        if (first) { try { first.focus(); } catch(_) {} }

        // Mensaje accesible
        document.getElementById('selectedLetter').textContent = `Letra seleccionada: ${data.letter}. ¬°A escribir!`;
      } catch (e) {
        console.error('Error en handleRoundStart:', e);
      }
    }

    function handleStartReview(data) {
      try {
        // Bloquear entradas y bot√≥n de enviar
        gameState.disableInputs();
        if (submitWordButton) submitWordButton.disabled = true;
        // Abrir modal de revisi√≥n
        uiManager.openReviewModal(data, { isHost: !!gameState.isHost });
      } catch (e) {
        console.error('Error en handleStartReview:', e);
      }
    }

    function handleVoteUpdate(data) {
      try {
        uiManager.updateVoteCounts(data);
      } catch (e) {
        console.error('Error en handleVoteUpdate:', e);
      }
    }

    function handleReviewEnded(data) {
      try {
        // Cerrar modal de revisi√≥n; los resultados llegar√°n por ROUND_ENDED
        uiManager.closeReviewModal();
      } catch (e) {
        console.error('Error en handleReviewEnded:', e);
      }
    }

    function handleTimerUpdate(data) {
      gameState.timeRemaining = data.timeRemaining;
      gameState.updateTimerDisplay();
      
      // Advertencia cuando queden pocos segundos
      if (data.timeRemaining <= 10 && data.timeRemaining > 0) {
        if (data.timeRemaining <= 5) {
          uiManager.announce(`¬°${data.timeRemaining} segundos!`);
        }
      }
      if (data.timeRemaining <= 0) {
        // Evitar acciones locales; el servidor cerrar√° la ronda
        gameState.clearTimer();
      }
    }

    function handleRoundEnded(data) {
      console.log('[Game] handleRoundEnded ->', data);
      
      gameState.clearTimer();
      gameState.disableInputs();
      gameState.updatePlayerScore(data.scores);
      
      // Mostrar resultados
      uiManager.showRoundResults(data);
      
      // Limpiar campos para la siguiente ronda
      clearWordInputs();
      
      uiManager.announce('La ronda ha terminado. Revisa los resultados.');
      
      // Preparar para la siguiente ronda: esperar ROUND_START del servidor
      const selectedLetterEl = document.getElementById('selectedLetter');
      if (selectedLetterEl) {
        selectedLetterEl.textContent = 'Esperando siguiente ronda...';
      }
    }

    function handleGameEnded(data) {
      console.log('Juego terminado:', data);
      
      gameState.clearTimer();
      gameState.gameStarted = false;
      
      // Mostrar resultados finales
      showGameResults(data.results);
      
      uiManager.announce('El juego ha terminado. Revisa los resultados finales.');
    }

    function moveToNextCategory(currentIndex) {
      const wordInputs = document.querySelectorAll('.word-input');
      const nextIndex = (currentIndex + 1) % wordInputs.length;
      
      if (nextIndex < wordInputs.length && !wordInputs[nextIndex].disabled) {
        wordInputs[nextIndex].focus();
      }
    }

    function checkAllWordsCompleted() {
      const wordInputs = document.querySelectorAll('.word-input');
      const allCompleted = Array.from(wordInputs).every(input => 
        input.disabled || input.value.trim().length > 0
      );
      
      // Habilitar bot√≥n si al menos una palabra est√° completa
      const anyCompleted = Array.from(wordInputs).some(input => 
        !input.disabled && input.value.trim().length > 0
      );
      
      if (submitWordButton) {
        submitWordButton.disabled = !anyCompleted;
      }
    }

    function submitWordsClassic() {
      const words = {};
      let hasValidWords = false;
      let hasInvalid = false;

      // Recopilar palabras leyendo la grilla din√°mica renderizada (no depender de constantes)
      const inputs = document.querySelectorAll('.word-input');
      inputs.forEach((input) => {
        const category = input.getAttribute('data-category');
        if (!category) return;

        const word = (input.value || '').trim();
        words[category] = word;

        if (word) {
          hasValidWords = true;

          // Validar que comience con la letra correcta
          if (gameState.currentLetter && !validateWord(word, gameState.currentLetter)) {
            hasInvalid = true;
            showNotification(
              `La palabra "${word}" debe comenzar con la letra "${gameState.currentLetter}" para la categor√≠a "${category}"`,
              'error'
            );
            try { input.focus(); } catch (_) {}
          }
        }
      });

      if (hasInvalid) {
        return; // Abortamos el env√≠o si hay alguna entrada inv√°lida
      }

      if (!hasValidWords) {
        showNotification('Debes ingresar al menos una palabra', 'warning');
        return;
      }
      
      // Enviar las palabras al servidor
      socketManager.submitWords(gameState.roomId, gameState.username, words);
      
      // Deshabilitar campos y bot√≥n
      gameState.disableInputs();
      
      // Mostrar mensaje de confirmaci√≥n
      document.getElementById('selectedLetter').textContent = 'Palabras enviadas. Esperando a los dem√°s jugadores...';
      uiManager.announce('Palabras enviadas correctamente');
      showNotification('¬°Palabras enviadas!', 'success');
    }

    function clearWordInputs() {
      // Limpiar inputs din√°micos
      const wordInputs = document.querySelectorAll('.word-input');
      wordInputs.forEach(input => {
        input.value = '';
      });

      // Limpiar displays si existen (compatibilidad con layout anterior)
      document.querySelectorAll('.word-display').forEach((displayDiv) => {
        displayDiv.classList.remove('valid', 'invalid', 'empty');
        displayDiv.classList.add('empty');
        const text = displayDiv.querySelector('.word-text');
        if (text) text.textContent = '';
      });
    }

    function showGameResults(results) {
      // Crear modal de resultados finales
      const modal = uiManager.createModal('gameResults', 'Resultados Finales');
      
      let resultsHTML = '<h3>üèÜ Clasificaci√≥n Final</h3>';
      
      // Ordenar por puntuaci√≥n
      const sortedResults = results.sort((a, b) => b.score - a.score);
      
      resultsHTML += '<div class="final-scores">';
      sortedResults.forEach((player, index) => {
        const position = index + 1;
        const emoji = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : 'üèÖ';
        
        resultsHTML += `
          <div class="final-score-item ${position === 1 ? 'winner' : ''}">
            <span class="position">${emoji} ${position}¬∞</span>
            <span class="player-name">${player.name}</span>
            <span class="final-score">${player.score} puntos</span>
          </div>
        `;
      });
      resultsHTML += '</div>';
      
      // Botones de acci√≥n
      resultsHTML += `
        <div class="game-end-actions">
          <button type="button" class="btn btn--primary" onclick="location.reload()">
            üîÑ Jugar de nuevo
          </button>
          <button type="button" class="btn btn--secondary" onclick="location.href='${ROUTES.HOME}'">
            üè† Volver al inicio
          </button>
        </div>
      `;
      
      modal.querySelector('.modal__body').innerHTML = resultsHTML;
      uiManager.openModal('gameResults');
      
      // Agregar estilos espec√≠ficos
      const style = document.createElement('style');
      style.textContent = `
        .final-scores {
          display: grid;
          gap: var(--space-3);
          margin: var(--space-6) 0;
        }
        
        .final-score-item {
          display: flex;
          align-items: center;
          gap: var(--space-3);
          padding: var(--space-4);
          background: var(--color-gray-50);
          border-radius: var(--radius-lg);
          border: 2px solid var(--color-gray-200);
        }
        
        .final-score-item.winner {
          background: linear-gradient(135deg, #ffd700, #ffed4e);
          border-color: #ffd700;
          font-weight: var(--font-weight-semibold);
        }
        
        .position {
          font-size: var(--text-lg);
          min-width: 60px;
        }
        
        .player-name {
          flex: 1;
          font-weight: var(--font-weight-medium);
        }
        
        .final-score {
          font-weight: var(--font-weight-bold);
          color: var(--color-primary);
        }
        
        .game-end-actions {
          display: flex;
          gap: var(--space-3);
          justify-content: center;
          margin-top: var(--space-6);
        }
      `;
      document.head.appendChild(style);
    }

    // Limpieza al salir de la p√°gina
    window.addEventListener('beforeunload', () => {
      gameState.clearTimer();
      socketManager.disconnect();
    });
  </script>
</body>
</html>
