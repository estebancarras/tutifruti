<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Votaci√≥n - Tutifrutti</title>
  
  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/base.css">
  <link rel="stylesheet" href="/public/css/components.css">
  
  <style>
    /* Estilos espec√≠ficos para la pantalla de votaci√≥n */
    .voting-screen {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .voting-header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .voting-title {
      font-size: 2.5rem;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 10px;
    }

    .voting-subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 20px;
    }

    .voting-timer {
      background: rgba(255,255,255,0.2);
      border-radius: 25px;
      padding: 10px 20px;
      display: inline-block;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .voting-container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255,255,255,0.98);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .voting-instructions {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px 20px;
      margin-bottom: 30px;
      border-radius: 8px;
    }

    .category-section {
      margin-bottom: 40px;
    }

    .category-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    .words-grid {
      display: grid;
      gap: 15px;
      grid-template-columns: 1fr;
    }

    .no-words-message {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 2px dashed #ddd;
    }

    .word-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 15px 20px;
      transition: all 0.3s ease;
    }

    .word-item.invalid {
      background: #ffebee;
      border-color: #f44336;
      opacity: 0.7;
    }

    .word-item.valid {
      background: #e8f5e8;
      border-color: #4caf50;
    }

    .word-item.own-word {
      background: #fff3e0;
      border-color: #ff9800;
      cursor: not-allowed;
    }

    .word-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }

    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .word-details {
      flex: 1;
    }

    .player-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
    }

    .word-text {
      font-size: 1.1rem;
      color: #666;
    }

    .word-text.empty {
      font-style: italic;
      color: #999;
    }

    .vote-toggle {
      position: relative;
      width: 60px;
      height: 30px;
      background: #4caf50;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      outline: none;
    }

    .vote-toggle.invalid {
      background: #f44336;
    }

    .vote-toggle.disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .vote-toggle::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .vote-toggle.invalid::before {
      transform: translateX(30px);
    }

    .vote-status {
      margin-left: 15px;
      font-weight: 600;
      min-width: 70px;
    }

    .vote-status.valid {
      color: #4caf50;
    }

    .vote-status.invalid {
      color: #f44336;
    }

    .vote-status.own {
      color: #ff9800;
    }

    .voting-actions {
      text-align: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #eee;
    }

    .validate-button {
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 25px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .validate-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
    }

    .validate-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .progress-indicator {
      margin-top: 20px;
      color: #666;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .voting-screen {
        padding: 10px;
      }
      
      .voting-container {
        padding: 20px;
      }
      
      .word-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .vote-toggle {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body class="voting-screen">
  <!-- Header de votaci√≥n -->
  <header class="voting-header">
    <h1 class="voting-title">üó≥Ô∏è Fase de Votaci√≥n</h1>
    <p class="voting-subtitle">Ronda <span id="currentRound">1</span> - Letra: <strong id="currentLetter">A</strong></p>
    <div class="voting-timer">
      ‚è±Ô∏è Tiempo restante: <span id="votingTimer">60s</span>
    </div>
  </header>

  <!-- Contenedor principal -->
  <main class="voting-container">
    <!-- Instrucciones -->
    <div class="voting-instructions">
      <strong>üìã Instrucciones:</strong><br>
      ‚Ä¢ Revisa las palabras de cada categor√≠a de todos los jugadores<br>
      ‚Ä¢ Todas las palabras inician como <strong>v√°lidas</strong> (interruptor verde)<br>
      ‚Ä¢ Haz clic en el interruptor para marcar una palabra como <strong>inv√°lida</strong> (interruptor rojo)<br>
      ‚Ä¢ No puedes votar sobre tus propias palabras<br>
      ‚Ä¢ Cuando termines de revisar, presiona "Validar Resultados"
    </div>

    <!-- Contenedor de categor√≠as -->
    <div id="categoriesContainer">
      <!-- Se llenar√° din√°micamente -->
    </div>

    <!-- Acciones -->
    <div class="voting-actions">
      <button id="validateButton" class="validate-button">
        ‚úÖ Validar Resultados
      </button>
      <div class="progress-indicator">
        <span id="playersReady">0</span> de <span id="totalPlayers">0</span> jugadores han validado
      </div>
    </div>
  </main>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- Scripts -->
  <script type="module">
    import { socketManager } from '/public/js/socket-manager.js';
    import { showNotification } from '/utils/helpers.js';

    // Estado de la votaci√≥n
    let votingState = {
      roomId: null,
      playerName: null,
      words: {},
      votes: {},
      timeRemaining: 60,
      playersReady: 0,
      totalPlayers: 0,
      hasValidated: false
    };

    // Elementos DOM
    const currentRoundEl = document.getElementById('currentRound');
    const currentLetterEl = document.getElementById('currentLetter');
    const votingTimerEl = document.getElementById('votingTimer');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const validateButton = document.getElementById('validateButton');
    const playersReadyEl = document.getElementById('playersReady');
    const totalPlayersEl = document.getElementById('totalPlayers');

    // Inicializaci√≥n
    init();

    function init() {
      // Obtener datos de la URL
      const urlParams = new URLSearchParams(window.location.search);
      votingState.roomId = urlParams.get('roomId');
      votingState.playerName = localStorage.getItem('username');

      if (!votingState.roomId || !votingState.playerName) {
        showNotification('Error: Datos de sesi√≥n inv√°lidos', 'error');
        window.location.href = '/';
        return;
      }

      // Conectar socket
      socketManager.connect();
      setupSocketListeners();

      // Configurar eventos
      validateButton.addEventListener('click', handleValidateResults);

      // Solicitar datos de votaci√≥n
      socketManager.emit('requestVotingData', { roomId: votingState.roomId });

      console.log('Pantalla de votaci√≥n inicializada');
    }

    function setupSocketListeners() {
      socketManager.on('votingData', handleVotingData);
      socketManager.on('voteUpdate', handleVoteUpdate);
      socketManager.on('votingProgress', handleVotingProgress);
      socketManager.on('votingComplete', handleVotingComplete);
      socketManager.on('votingTimer', handleVotingTimer);
    }

    function handleVotingData(data) {
      console.log('Datos de votaci√≥n recibidos:', data);
      
      // Actualizar estado
      votingState.words = data.words || {};
      votingState.timeRemaining = data.timeRemaining || 60;
      votingState.totalPlayers = data.totalPlayers || 0;
      
      // Actualizar UI
      currentRoundEl.textContent = data.round || 1;
      currentLetterEl.textContent = data.letter || 'A';
      totalPlayersEl.textContent = votingState.totalPlayers;
      
      // Inicializar votos (todas las palabras v√°lidas por defecto)
      initializeVotes();
      
      // Renderizar categor√≠as con palabras
      renderCategories(data.categories || [], votingState.words);
      
      // Verificar si hay palabras para votar
      const hasWordsToVote = Object.keys(votingState.votes).length > 0;
      if (!hasWordsToVote) {
        showNotification('No hay palabras para votar en esta ronda', 'info');
      }
      
      // Iniciar timer
      startTimer();
    }

    function initializeVotes() {
      votingState.votes = {};
      
      Object.keys(votingState.words).forEach(playerName => {
        if (playerName !== votingState.playerName) {
          Object.keys(votingState.words[playerName]).forEach(category => {
            const word = votingState.words[playerName][category];
            if (word && word.trim()) {
              const key = `${playerName}-${category}`;
              votingState.votes[key] = true; // Iniciar como v√°lida
            }
          });
        }
      });
    }

    function renderCategories(categories, words) {
      categoriesContainer.innerHTML = '';

      categories.forEach(category => {
        const categorySection = document.createElement('div');
        categorySection.className = 'category-section';
        
        categorySection.innerHTML = `
          <h2 class="category-title">${category}</h2>
          <div class="words-grid" id="category-${category}">
          </div>
        `;
        
        categoriesContainer.appendChild(categorySection);
        
        const wordsGrid = categorySection.querySelector('.words-grid');
        let hasWordsInCategory = false;
        
        // Renderizar palabras de todos los jugadores
        Object.keys(words).forEach(playerName => {
          const word = words[playerName][category] || '';
          const isOwnWord = playerName === votingState.playerName;
          const key = `${playerName}-${category}`;
          
          // Mostrar todas las palabras (incluso vac√≠as) para transparencia completa
          const wordItem = document.createElement('div');
          wordItem.className = `word-item ${isOwnWord ? 'own-word' : 'valid'}`;
          wordItem.id = `word-${key}`;
          
          wordItem.innerHTML = `
            <div class="word-info">
              <div class="player-avatar">${playerName.charAt(0).toUpperCase()}</div>
              <div class="word-details">
                <div class="player-name">${playerName}</div>
                <div class="word-text ${!word ? 'empty' : ''}">${word || '(sin palabra)'}</div>
              </div>
            </div>
            ${!isOwnWord && word ? `
              <button 
                class="vote-toggle" 
                data-key="${key}"
                title="Clic para marcar como inv√°lida"
              ></button>
              <div class="vote-status valid">V√°lida</div>
            ` : `
              <div class="vote-status own">
                ${isOwnWord ? 'Tu palabra' : 'Sin palabra'}
              </div>
            `}
          `;
          
          wordsGrid.appendChild(wordItem);
          hasWordsInCategory = true;
          
          // Agregar evento de clic si no es palabra propia y tiene contenido
          if (!isOwnWord && word) {
            const toggle = wordItem.querySelector('.vote-toggle');
            toggle.addEventListener('click', () => toggleVote(key));
          }
        });
        
        // Si no hay palabras en esta categor√≠a, mostrar mensaje
        if (!hasWordsInCategory) {
          wordsGrid.innerHTML = '<div class="no-words-message">No hay palabras en esta categor√≠a</div>';
        }
      });
    }

    function toggleVote(key) {
      if (votingState.hasValidated) {
        showNotification('Ya has validado tus resultados', 'warning');
        return;
      }

      // Cambiar estado del voto
      votingState.votes[key] = !votingState.votes[key];
      
      // Actualizar UI
      updateWordItemUI(key);
      
      // Enviar voto al servidor
      const [playerName, category] = key.split('-');
      socketManager.emit('castVote', {
        roomId: votingState.roomId,
        targetPlayer: playerName,
        category: category,
        isValid: votingState.votes[key],
        voter: votingState.playerName
      });
    }

    function updateWordItemUI(key) {
      const wordItem = document.getElementById(`word-${key}`);
      const toggle = wordItem.querySelector('.vote-toggle');
      const status = wordItem.querySelector('.vote-status');
      
      const isValid = votingState.votes[key];
      
      // Actualizar clases
      wordItem.className = `word-item ${isValid ? 'valid' : 'invalid'}`;
      toggle.className = `vote-toggle ${isValid ? '' : 'invalid'}`;
      
      // Actualizar texto de estado
      status.textContent = isValid ? 'V√°lida' : 'Inv√°lida';
      status.className = `vote-status ${isValid ? 'valid' : 'invalid'}`;
    }

    function handleVoteUpdate(data) {
      // Actualizar contadores si es necesario
      console.log('Actualizaci√≥n de voto:', data);
    }

    function handleVotingProgress(data) {
      votingState.playersReady = data.playersReady || 0;
      playersReadyEl.textContent = votingState.playersReady;
    }

    function handleVotingComplete(data) {
      showNotification('¬°Votaci√≥n completada! Calculando resultados...', 'success');
      
      // Redirigir a resultados o siguiente ronda
      setTimeout(() => {
        window.location.href = `/views/game.html?roomId=${votingState.roomId}`;
      }, 2000);
    }

    function handleVotingTimer(data) {
      votingState.timeRemaining = data.timeRemaining;
      updateTimerDisplay();
      
      if (votingState.timeRemaining <= 0) {
        handleTimeUp();
      }
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(votingState.timeRemaining / 60);
      const seconds = votingState.timeRemaining % 60;
      votingTimerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Cambiar color cuando quede poco tiempo
      if (votingState.timeRemaining <= 10) {
        votingTimerEl.style.color = '#f44336';
        votingTimerEl.parentElement.style.background = 'rgba(244, 67, 54, 0.2)';
      }
    }

    function startTimer() {
      const interval = setInterval(() => {
        votingState.timeRemaining--;
        updateTimerDisplay();
        
        if (votingState.timeRemaining <= 0) {
          clearInterval(interval);
          handleTimeUp();
        }
      }, 1000);
    }

    function handleTimeUp() {
      if (!votingState.hasValidated) {
        showNotification('¬°Tiempo agotado! Validando autom√°ticamente...', 'warning');
        handleValidateResults();
      }
    }

    function handleValidateResults() {
      if (votingState.hasValidated) {
        showNotification('Ya has validado tus resultados', 'warning');
        return;
      }

      // Verificar que el jugador haya revisado todas las palabras disponibles
      const totalWordsToVote = Object.keys(votingState.votes).length;
      if (totalWordsToVote === 0) {
        showNotification('No hay palabras para validar en esta ronda', 'info');
      }

      votingState.hasValidated = true;
      validateButton.disabled = true;
      validateButton.textContent = '‚úÖ Validado';
      validateButton.style.background = '#4caf50';
      
      // Deshabilitar todos los toggles
      document.querySelectorAll('.vote-toggle').forEach(toggle => {
        toggle.disabled = true;
        toggle.style.opacity = '0.5';
      });
      
      // Enviar validaci√≥n al servidor con los votos actuales
      socketManager.emit('validateVoting', {
        roomId: votingState.roomId,
        playerName: votingState.playerName,
        votes: votingState.votes
      });
      
      showNotification('Resultados validados. Esperando a otros jugadores...', 'success');
    }

    // Prevenir salida accidental
    window.addEventListener('beforeunload', (e) => {
      if (!votingState.hasValidated) {
        e.preventDefault();
        e.returnValue = '¬øEst√°s seguro de que quieres salir sin validar?';
      }
    });
  </script>
</body>
</html>
